{% extends "base.html" %}

{% block title %}Active Users - TTT Rewards{% endblock %}

{% block styles %}
  {{ super() }} {# Ensure theme.css + style.css are included #}
{% endblock %}

{% block content %}
  <div class="container">
    <div class="card">
      {# Flash messages using your .alert styles #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              {% if category == 'success' %}
                <div class="alert success" role="alert">{{ message | safe }}</div> {# Use safe filter for flashed HTML #}
              {% elif category == 'danger' %}
                <div class="alert error" role="alert">{{ message | safe }}</div>
              {% elif category == 'warning' %}
                <div class="alert warning" role="alert">{{ message | safe }}</div>
              {% else %}
                <div class="alert" role="status">{{ message | safe }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="app-header-row" style="display:flex; align-items:center; gap:.75rem; margin-bottom:1rem;">
        <a href="{{ url_for('administrator_bp.dashboard') }}" class="btn btn-outline" aria-label="Back to Administrator Dashboard">
          ‚Üê Back
        </a>
        <h1 style="margin:0;">Active Users</h1>
        {# Optional: Add search form here if desired based on backend route #}
        {# <form method="GET" action="{{ url_for('administrator_bp.accounts') }}"> #}
        {#   <input type="search" name="search" placeholder="Search users..." value="{{ search_term or '' }}"> #}
        {#   <button type="submit">Search</button> #}
        {# </form> #}
      </div>

      {% if accounts %}
        <table aria-describedby="active-users-caption">
          <caption id="active-users-caption" class="text-muted" style="text-align:left; padding:.5rem 0;">
            List of currently active users. {% if search_term %}Filtered by: "{{ search_term }}"{% endif %}
          </caption>
          <thead>
            <tr>
              <th scope="col">Username</th>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Type</th>
              <th scope="col">Joined</th>
              <th scope="col" style="min-width: 220px;">Actions</th> {# Increased width for more buttons #}
            </tr>
          </thead>
          <tbody>
          {% for user in accounts %}
            <tr>
              <td><strong>{{ user.USERNAME }}</strong></td>
              <td>{{ user.FNAME }} {{ user.LNAME }}</td>
              <td>{{ user.EMAIL }}</td>
              <td>
                <span class="badge">{{ user.USER_TYPE | capitalize }}</span> {# Capitalize type #}
              </td>
              <td>{{ user.CREATED_AT.strftime('%Y-%m-%d') }}</td> {# Simpler date format #}
              <td>
                <div style="display:flex; flex-wrap: wrap; gap:.5rem; align-items:center;"> {# Allow wrapping #}
                  {# --- Impersonate Button (from 078d...) --- #}
                  {# Only show if not impersonating self and allowed #}
                  {% if user.USER_CODE != current_user.USER_CODE and allowed_to_impersonate(user) %} {# Assuming allowed_to_impersonate is available in template context #}
                  <form method="POST" action="{{ url_for('impersonation_bp.start_impersonation', target_id=user.USER_CODE) }}" style="display:inline; margin:0;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-outline small" title="Impersonate {{ user.USERNAME }}">
                      Impersonate
                    </button>
                  </form>
                  {% endif %}

                  {# --- Edit Button --- #}
                  <a
                    href="{{ url_for('administrator_bp.edit_user', user_id=user.USER_CODE) }}"
                    class="btn btn-outline small" {# Made small for consistency #}
                    title="Edit user {{ user.USERNAME }}"
                    aria-label="Edit user {{ user.USERNAME }}"
                  >
                    Edit
                  </a>

                  {# --- Disable Button --- #}
                  {% if user.USER_CODE != current_user.USER_CODE %} {# Can't disable self #}
                  <form
                    method="POST"
                    action="{{ url_for('administrator_bp.disable_user', user_id=user.USER_CODE) }}"
                    onsubmit="return confirm('WARNING: Are you sure you want to disable {{ user.USERNAME }}? This will set the account to inactive.');"
                    style="display:inline-block; margin:0;"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button
                      type="submit"
                      class="btn small" {# Made small #}
                      style="background: var(--warning); color:#fff; border-color: transparent;" {# Changed to warning color #}
                      title="Disable user {{ user.USERNAME }}"
                      aria-label="Disable user {{ user.USERNAME }}"
                    >
                      Disable
                    </button>
                  </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="box" role="status">
          <p class="text-muted" style="margin:0;">No active users found{% if search_term %} matching "{{ search_term }}"{% endif %}.</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {# No page-specific JS needed #}
{% endblock %}