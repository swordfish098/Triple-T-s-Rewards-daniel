{% extends "base.html" %}

{% block title %}Active Users - TTT Rewards{% endblock %}

{% block styles %}
  {{ super() }} {# Ensure theme.css + style.css are included #}
  {# No page-level CSS: we rely on the app styles only #}
{% endblock %}

{% block content %}
  <div class="container">
    <div class="card">
      {# Flash messages using your .alert styles #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              {% if category == 'success' %}
                <div class="alert success" role="alert">{{ message }}</div>
              {% elif category == 'danger' %}
                <div class="alert error" role="alert">{{ message }}</div>
              {% elif category == 'warning' %}
                <div class="alert warning" role="alert">{{ message }}</div>
              {% else %}
                <div class="alert" role="status">{{ message }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="app-header-row" style="display:flex; align-items:center; gap:.75rem; margin-bottom:1rem;">
        <a href="{{ url_for('administrator_bp.dashboard') }}" class="btn btn-outline" aria-label="Back to Administrator Dashboard">
          ‚Üê Back
        </a>
        <h1 style="margin:0;">Active Users</h1>
      </div>

      {% if accounts %}
        <table aria-describedby="active-users-caption">
          <caption id="active-users-caption" class="text-muted" style="text-align:left; padding:.5rem 0;">
            List of currently active users
          </caption>
          <thead>
            <tr>
              <th scope="col">Username</th>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Type</th>
              <th scope="col">Joined</th>
              <th scope="col" style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for user in accounts %}
            <tr>
              <td><strong>{{ user.USERNAME }}</strong></td>
              <td>{{ user.FNAME }} {{ user.LNAME }}</td>
              <td>{{ user.EMAIL }}</td>
              <td>
                <span class="badge">{{ user.USER_TYPE }}</span>
              </td>
              <td>{{ user.CREATED_AT.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <div style="display:flex; gap:.5rem; align-items:center;">
                  <form method="POST" action="{{ url_for('impersonation_bp.start_impersonation', target_id=user.USER_CODE) }}" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-outline small" title="Impersonate this user">
                      Impersonate
                    </button>
                  </form>

                  <a
                    href="{{ url_for('administrator_bp.edit_user', user_id=user.USER_CODE) }}"
                    class="btn btn-outline"
                    title="Edit user {{ user.USERNAME }}"
                    aria-label="Edit user {{ user.USERNAME }}"
                  >
                    Edit
                  </a>

                  {% if user.USER_CODE != current_user.USER_CODE %}
                  <form
                    method="POST"
                    action="{{ url_for('administrator_bp.disable_user', user_id=user.USER_CODE) }}"
                    onsubmit="return confirm('WARNING: Are you sure you want to disable {{ user.USERNAME }}? This will set the account to inactive.');"
                    style="display:inline-block; margin:0;"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button
                      type="submit"
                      class="btn"
                      style="background: var(--error); color:#fff; border-color: transparent;"
                      title="Disable user {{ user.USERNAME }}"
                      aria-label="Disable user {{ user.USERNAME }}"
                    >
                      Disable
                    </button>
                  </form>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="box" role="status">
          <p class="text-muted" style="margin:0;">No active users found.</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {# No page-specific JS needed #}
{% endblock %}
