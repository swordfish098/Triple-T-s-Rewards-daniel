{% extends "base.html" %}

{% block title %}Locked Users - TTT Rewards{% endblock %}

{% block styles %}
  {{ super() }} {# Ensure theme.css + style.css are included #}
{% endblock %}

{% block content %}
  <div class="container">
    <div class="card">

      {# Flash messages using your alert styles #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              {% if category == 'success' %}
                <div class="alert success" role="alert">{{ message }}</div>
              {% elif category == 'danger' %}
                <div class="alert error" role="alert">{{ message }}</div>
              {% elif category == 'warning' %}
                <div class="alert warning" role="alert">{{ message }}</div>
              {% else %}
                <div class="alert" role="status">{{ message }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div style="display:flex; align-items:center; gap:.75rem; margin-bottom:1rem;">
        <a href="{{ url_for('administrator_bp.dashboard') }}" class="btn btn-outline" aria-label="Back to Administrator Dashboard">
          ← Back
        </a>
        <h1 style="margin:0;">Locked Users</h1>
        <div style="flex:1;"></div>

        {# Unlock All (risky bulk action -> danger/warning styling) #}
        <form action="{{ url_for('administrator_bp.unlock_all') }}" method="POST"
              onsubmit="return confirm('WARNING: Unlock ALL users? This will remove lockout for every locked account.');"
              style="margin:0;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit"
                  class="btn btn-danger"
                  aria-label="Unlock all locked users">
            Unlock All
          </button>
        </form>
      </div>

      {% if locked_users %}
        <table aria-describedby="locked-users-caption">
          <caption id="locked-users-caption" class="text-muted" style="text-align:left; padding:.5rem 0;">
            Users currently locked out
          </caption>
          <thead>
            <tr>
              <th scope="col">Username</th>
              <th scope="col">Locked Since</th>
              <th scope="col" style="width: 140px;">Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for user in locked_users %}
            <tr>
              <td>
                <div><strong>{{ user.USERNAME }}</strong></div>
                <div class="text-muted" style="font-size:.9rem;">
                  {{ user.FNAME }} {{ user.LNAME }} · {{ user.EMAIL }}
                </div>
              </td>
              <td>{{ user.LOCKOUT_TIME.strftime('%Y-%m-%d %H:%M:%S') }}</td>
              <td>
                <form action="{{ url_for('administrator_bp.unlock', user_id=user.USER_CODE) }}"
                      method="POST"
                      onsubmit="return confirm('Unlock {{ user.USERNAME }}?');"
                      style="display:inline-block; margin:0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit"
                          class="btn btn-success"
                          aria-label="Unlock user {{ user.USERNAME }}">
                    Unlock
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="box" role="status">
          <p class="text-muted" style="margin:0;">No users are currently locked out.</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
{% endblock %}
