<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}TTT Rewards{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
    // Handles theme loading before page renders to prevent flash of wrong theme
    (function() {
      const saved = localStorage.getItem("theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const theme = saved || (prefersDark ? "dark" : "light");
      document.documentElement.setAttribute("data-theme", theme);
    })();
  </script>
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  {% block styles %}{% endblock %}
</head>

<body>

  {% include "partials/navbar.html" %}

  {% set show_sidebar = current_user.is_authenticated %}

  <div class="app-layout {% if show_sidebar %}with-sidebar{% endif %}">
      {% if show_sidebar %}
          {% include 'partials/sidebar.html' %}
      {% endif %}

      <main class="app-main-content">
          <div class="container">
              {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}
                      {% for category, message in messages %}
                          <div class="flash-messages {{ category }}">{{ message }}</div>
                      {% endfor %}
                  {% endif %}
              {% endwith %}
              
              {% block content %}{% endblock %}
          </div>
      </main>
  </div>

  {% include "partials/footer.html" %}

  
  {% block scripts %}
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
      function fetchNotificationCount() {
        if ("{{ current_user.is_authenticated }}" === "True") {
          fetch('{{ url_for("notification_bp.get_unread_count") }}')
            .then(response => response.ok ? response.json() : {})
            .then(data => {
              const countElement = document.getElementById('notification-count');
              if (data && data.count > 0) {
                countElement.textContent = data.count;
                countElement.style.display = 'inline-block'; 
              } else {
                countElement.style.display = 'none'; 
              }
            })
            .catch(error => console.error('Error fetching notifications:', error));
        }
      }

      function fetchCartCount() {
        if ("{{ current_user.is_authenticated }}" === "True") {
          fetch('{{ url_for("rewards_bp.cart_count") }}')
            .then(response => response.json())
            .then(data => {
              const countElement = document.getElementById('cart-item-count');
              if (data && data.count > 0) {
                countElement.textContent = `(${data.count})`;
              } else {
                countElement.textContent = '';
              }
            })
            .catch(error => console.error('Error fetching cart count:', error));
        }
      }

      // Initial fetch and start polling
      if (document.getElementById('notification-count')) fetchNotificationCount();
      if (document.getElementById('cart-item-count')) fetchCartCount();
      setInterval(fetchNotificationCount, 30000);
      setInterval(fetchCartCount, 30000);
    </script>
    <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  {% endblock %}
</body>
</html>