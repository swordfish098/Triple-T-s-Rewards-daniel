{% extends "base.html" %}
{% block content %}
<main class="app-main-content container">
  <h1>Manage Driver Points</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-messages {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if drivers %}
    <section class="summary-section">
      {% set total_points = drivers | sum(attribute='points') %}
      {% set avg_points = (total_points / (drivers|length)) | round(2) %}
      <div class="summary-card">
        <div class="summary-item">
          <h3>Total Points Across All Drivers</h3>
          <p class="summary-value">{{ total_points }}</p>
        </div>
        <div class="summary-item">
          <h3>Average Points per Driver</h3>
          <p class="summary-value">{{ avg_points }}</p>
        </div>
      </div>
    </section>

    <div class="controls-section" style="margin-bottom: 15px;">
      {% if current_sort != 'points_desc' %}
      <a href="{{ url_for('sponsor_bp.manage_points_page', sort_by='points_desc') }}" class="btn btn-secondary">
          Sort by Points (High to Low)
      </a>
      {% else %}
      <a href="{{ url_for('sponsor_bp.manage_points_page', sort_by='points_asc') }}" class="btn btn-secondary">
          Sort by Points (Low to High)
      </a>
      {% endif %}
      <a href="{{ url_for('sponsor_bp.manage_points_page') }}" class="btn btn-outline">
          Clear Sort
      </a>
  </div>

    <section class="data-section">
      <table class="data-table">
        <thead>
          <tr>
            <th>Driver</th>
            <th>Current Points</th>
            <th>Award Points</th>
            <th>Remove Points</th>
          </tr>
        </thead>
        <tbody>
          {% for driver in drivers %}
          <tr>
            <td>{{ driver.user.USERNAME }}</td>
            <td>
              <span class="current-points">{{ driver.points }}</span>
              <span class="points-preview" style="color: #007bff; font-style: italic; margin-left: 8px;"></span>
            </td>

            <td>
              <form
                method="POST"
                action="{{ url_for('sponsor_bp.manage_points', driver_id=driver.driver_id) }}"
                class="points-form"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="award">
                <input
                  type="number"
                  name="points"
                  min="1"
                  class="input-field compact"
                  placeholder="Points"
                  required
                >
                <button type="submit" class="btn btn-primary">Award</button>
              </form>
            </td>

            <td>
              <form
                method="POST"
                action="{{ url_for('sponsor_bp.manage_points', driver_id=driver.driver_id) }}"
                class="points-form"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="remove">
                <input
                  type="number"
                  name="points"
                  min="1"
                  class="input-field compact"
                  placeholder="Points"
                  required
                >
                <input
                  type="text"
                  name="reason"
                  class="input-field compact"
                  placeholder="Reason (optional)"
                >
                <button type="submit" class="btn btn-outline">Remove</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% else %}
    <p class="text-muted">No drivers found.</p>
  {% endif %}

  <div class="spacer"></div>
  <a href="{{ url_for('sponsor_bp.dashboard') }}" class="btn btn-outline">‚Üê Back to Dashboard</a>
</main>

<script src="{{ url_for('static', filename='js/points_preview.js') }}"></script>
{% endblock %}