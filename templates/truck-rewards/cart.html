{% extends "base.html" %}
{% block content %}
{# Removed redundant <head> and <body> tags which are handled by base.html #}
<section class="cart-page container">
  <h1>Your Shopping Cart</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if cart_items %}
    <div class="cart-items">
      {% for item in cart_items %}
        <div class="cart-item card">
          <img src="{{ item.image_url or 'https://ir.ebaystatic.com/cr/v/c1/s_1x2.gif' }}" alt="{{ item.title }}" class="cart-item-img">
          <div class="cart-item-details">
            <p class="item-title"><strong>{{ item.title }}</strong></p>
            <p class="item-points">{{ item.points }} points &times; {{ item.quantity }}</p>
          </div>
          <form method="POST" action="{{ url_for('rewards_bp.remove_from_cart', cart_item_id=item.id) }}">
            {{ csrf_token() }}
            <button type="submit" class="btn btn-outline">Remove</button>
          </form>
        </div>
      {% endfor %}
    </div>

    <div class="cart-summary card">
      <h3>Total Points: <span class="summary-value">{{ total_points }}</span></h3>
      {# Use current_points from the HEAD branch, which is sponsor-specific #}
      <p>Your Balance (with this sponsor): <strong>{{ current_points }}</strong> points</p>

      {% if addresses %}
        <div class="form-group">
          <label for="shipping_address">Select a Shipping Address:</label>
          <select id="shipping_address" name="shipping_address" class="input-field">
            {% for address in addresses %}
              <option value="{{ address.id }}" {% if address.is_default %}selected{% endif %}>
                {{ address.street }}, {{ address.city }}, {{ address.state }} {{ address.zip_code }}
              </option>
            {% endfor %}
          </select>
        </div>
      {% else %}
        <p>You have no saved addresses.
          {# Corrected link to point to driver blueprint #}
          <a href="{{ url_for('driver_bp.add_address') }}" class="link">Add one now.</a>
        </p>
      {% endif %}

      {# Use the condition with current_points from the HEAD branch #}
      {% if current_points >= total_points and addresses %}
        <form method="POST" action="{{ url_for('rewards_bp.checkout') }}">
          {{ csrf_token() }} {# <-- This generates the correct hidden input #}
          <button type="submit" class="btn btn-primary">Checkout</button>
        </form>
      {% elif not addresses %}
        <p class="text-danger">Please add a shipping address before checking out.</p>
      {% else %}
        <p class="text-danger">You don't have enough points with this sponsor to checkout.</p>
      {% endif %}
    </div>

    {# Clear Cart Form #}
    <form method="POST" action="{{ url_for('rewards_bp.clear_cart') }}" 
          onsubmit="return confirm('Are you sure you want to clear your entire cart?');" 
          class="clear-cart-form">
      {{ csrf_token() }} {# <-- This generates the correct hidden input #}
      <button type="submit" class="btn btn-outline" style="color: #ff4a4a; border-color: #ff4a4a;">Clear Entire Cart</button>
    </form>

  {% else %}
    <p>Your cart for this sponsor is empty.</p>
  {% endif %}

  <div class="cart-footer">
    <a href="{{ url_for('rewards_bp.store') }}" class="btn btn-secondary">‚Üê Back to Store</a>
  </div>
</section>
{% endblock %}